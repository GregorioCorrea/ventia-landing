<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ventia — COBROSMART Demo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0a0a0a;
      --paper:#f5f3ef;
      --ink:#111111;
      --muted:#8a8a8a;
      --green:#00c87a;
      --green-dim:rgba(0,200,122,0.12);
      --accent:#ff4d1c;
      --card:rgba(255,255,255,0.04);
      --border:rgba(255,255,255,0.10);
      --border-strong:rgba(255,255,255,0.16);
      --shadow:0 20px 48px rgba(0,0,0,0.40);
      --radius:16px;
      --font-display:'Plus Jakarta Sans', system-ui, sans-serif;
      --font-body:'IBM Plex Sans', system-ui, sans-serif;
    }
    *{ box-sizing:border-box; margin:0; padding:0; }
    html,body{ height:100%; }
    body{
      background:
        radial-gradient(ellipse 1000px 500px at 15% -5%, rgba(0,200,122,0.14) 0%, transparent 60%),
        radial-gradient(ellipse 700px 400px at 95% 8%, rgba(255,77,28,0.09) 0%, transparent 55%),
        var(--bg);
      color:var(--paper);
      font-family:var(--font-body);
      font-size:14px;
      line-height:1.5;
      -webkit-font-smoothing:antialiased;
    }

    /* ── Layout ── */
    .app{ max-width:1120px; margin:0 auto; padding:16px 16px 48px; }

    /* ── Header ── */
    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:10px 0 20px; flex-wrap:wrap;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .logo-svg{ width:32px; height:32px; flex-shrink:0; }
    .brand-text .kicker{
      font-family:var(--font-body); font-size:11px; font-weight:500;
      letter-spacing:0.08em; text-transform:uppercase;
      color:rgba(245,243,239,0.55);
    }
    .brand-text h1{
      font-family:var(--font-display); font-weight:800; font-size:17px;
      letter-spacing:-0.02em; color:var(--paper); line-height:1.1;
    }
    .pills{ display:flex; gap:8px; flex-wrap:wrap; }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 12px; border:1px solid var(--border);
      background:rgba(255,255,255,0.03); border-radius:999px;
      font-family:var(--font-body); font-size:12px; font-weight:400;
      color:rgba(245,243,239,0.70);
    }
    .pill strong{ font-weight:600; color:rgba(245,243,239,0.90); }

    /* ── Screen transitions ── */
    .screen{ display:none; animation:fadeUp 220ms ease-out; }
    .screen.active{ display:block; }
    @keyframes fadeUp{
      from{ opacity:0; transform:translateY(6px); }
      to{ opacity:1; transform:translateY(0); }
    }

    /* ── Cards ── */
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:var(--radius); padding:20px;
    }
    .card + .card{ margin-top:12px; }
    .card h2{
      font-family:var(--font-display); font-weight:700; font-size:15px;
      letter-spacing:-0.01em; margin-bottom:4px;
    }
    .subtle{ font-size:13px; color:rgba(245,243,239,0.55); font-weight:400; }

    /* ── Buttons ── */
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px; padding:10px 18px; border:0; border-radius:12px;
      font-family:var(--font-display); font-size:13px; font-weight:700;
      cursor:pointer; transition:all 0.12s ease; user-select:none;
      white-space:nowrap;
    }
    .btn:active{ transform:scale(0.98); }
    .btn-primary{
      background:var(--green); color:var(--ink);
      box-shadow:0 8px 24px rgba(0,200,122,0.25);
    }
    .btn-primary:hover{ filter:brightness(1.05); box-shadow:0 12px 32px rgba(0,200,122,0.35); }
    .btn-ghost{
      background:rgba(255,255,255,0.05); border:1px solid var(--border);
      color:rgba(245,243,239,0.85);
    }
    .btn-ghost:hover{ background:rgba(255,255,255,0.08); }
    .btn-sm{ padding:8px 14px; font-size:12px; border-radius:10px; }
    .btn-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    /* ── Screen 1 — Metrics ── */
    .metrics{
      display:grid;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:10px; margin:16px 0;
    }
    .metric{
      background:rgba(255,255,255,0.03); border:1px solid var(--border);
      border-radius:14px; padding:14px;
    }
    .metric .m-label{
      font-size:11px; font-weight:500; letter-spacing:0.04em;
      text-transform:uppercase; color:rgba(245,243,239,0.50);
      margin-bottom:8px;
    }
    .metric .m-value{
      font-family:var(--font-display); font-weight:800; font-size:22px;
      letter-spacing:-0.03em; line-height:1;
    }
    .metric .m-hint{
      font-size:12px; color:rgba(245,243,239,0.45); margin-top:6px;
    }

    /* ── Age bars ── */
    .bars{ display:grid; gap:8px; margin-top:14px; }
    .bar-row{
      display:grid; grid-template-columns:76px 1fr 108px;
      gap:10px; align-items:center;
      padding:9px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.07);
      background:rgba(255,255,255,0.025);
    }
    .bar-row .b-label{
      font-family:var(--font-body); font-size:12px; font-weight:500;
      color:rgba(245,243,239,0.75);
    }
    .bar-track{
      height:8px; border-radius:999px;
      background:rgba(255,255,255,0.08); overflow:hidden;
    }
    .bar-fill{
      height:100%; border-radius:999px;
      background:rgba(0,200,122,0.50);
      transition:width 0.6s cubic-bezier(0.16,1,0.3,1);
    }
    .bar-row.prio .bar-fill{ background:rgba(0,200,122,0.90); }
    .bar-row.prio2 .bar-fill{ background:rgba(0,200,122,0.75); }
    .bar-row .b-amt{
      font-family:var(--font-body); font-size:12px; font-weight:500;
      color:rgba(245,243,239,0.80); text-align:right;
      font-variant-numeric:tabular-nums;
    }

    /* ── ROI strip ── */
    .roi-strip{
      margin-top:12px; padding:14px 16px;
      border:1px solid rgba(255,77,28,0.22);
      background:rgba(255,77,28,0.08); border-radius:14px;
    }
    .roi-strip .roi-top{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
    }
    .roi-strip .roi-big{
      font-family:var(--font-display); font-weight:700; font-size:14px;
      letter-spacing:-0.01em;
    }
    .roi-strip .roi-big span{ color:var(--paper); }
    .roi-strip .roi-small{
      font-size:12px; color:rgba(245,243,239,0.60);
      margin-top:6px; line-height:1.4;
    }

    /* ── Screen 2 ── */
    .split{
      display:grid; grid-template-columns:1.2fr 0.8fr;
      gap:14px; align-items:start; margin-top:14px;
    }

    /* Table */
    .table-wrap{ overflow:hidden; border-radius:var(--radius); border:1px solid var(--border); }
    table{ width:100%; border-collapse:collapse; }
    thead th{
      font-family:var(--font-body); font-size:11px; font-weight:600;
      letter-spacing:0.05em; text-transform:uppercase;
      color:rgba(245,243,239,0.50); padding:10px 14px;
      border-bottom:1px solid var(--border); background:rgba(255,255,255,0.03);
      text-align:left;
    }
    thead th.tc{ text-align:center; }
    thead th.tr{ text-align:right; }
    tbody tr{
      cursor:pointer; transition:background 0.10s ease;
      border-bottom:1px solid rgba(255,255,255,0.06);
    }
    tbody tr:last-child{ border-bottom:0; }
    tbody tr:hover{ background:rgba(255,255,255,0.04); }
    tbody tr.selected{
      background:rgba(0,200,122,0.08);
      outline:1px solid rgba(0,200,122,0.35);
      outline-offset:-1px;
    }
    tbody td{
      font-family:var(--font-body); font-size:13px; font-weight:400;
      color:rgba(245,243,239,0.85); padding:11px 14px;
      vertical-align:middle;
    }
    td.tc{ text-align:center; }
    td.tr{ text-align:right; font-variant-numeric:tabular-nums; font-weight:500; }

    /* Badges */
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:5px 10px; border-radius:999px; font-size:11px;
      font-family:var(--font-body); font-weight:600;
      border:1px solid var(--border); white-space:nowrap;
    }
    .dot{ width:7px; height:7px; border-radius:50%; }
    .s-red{ border-color:rgba(255,77,28,0.30); background:rgba(255,77,28,0.10); }
    .s-red .dot{ background:var(--accent); }
    .s-yellow{ border-color:rgba(245,213,60,0.30); background:rgba(245,213,60,0.10); }
    .s-yellow .dot{ background:rgba(245,213,60,0.95); }
    .s-green{ border-color:rgba(0,200,122,0.30); background:rgba(0,200,122,0.10); }
    .s-green .dot{ background:var(--green); }

    /* Message panel */
    .msg-panel{ display:flex; flex-direction:column; gap:12px; }
    .panel-head{ display:flex; align-items:flex-start; justify-content:space-between; gap:8px; }
    .panel-head h3{
      font-family:var(--font-display); font-weight:700; font-size:14px;
      letter-spacing:-0.01em; line-height:1.2;
    }
    .panel-head .p-meta{ font-size:12px; color:rgba(245,243,239,0.50); margin-top:3px; }

    /* Tone segmented control */
    .tone-seg{
      display:flex; border:1px solid var(--border);
      border-radius:10px; overflow:hidden; width:fit-content;
    }
    .tone-seg button{
      border:0; cursor:pointer; padding:8px 14px;
      background:transparent; color:rgba(245,243,239,0.70);
      font-family:var(--font-display); font-size:12px; font-weight:600;
      transition:background 0.10s ease, color 0.10s ease;
    }
    .tone-seg button:not(:last-child){ border-right:1px solid var(--border); }
    .tone-seg button.active{
      background:rgba(0,200,122,0.15); color:rgba(245,243,239,0.95);
    }
    .tone-seg button:hover:not(.active){ background:rgba(255,255,255,0.05); }

    /* WhatsApp preview bubble */
    .msg-preview{
      background:rgba(0,0,0,0.30); border:1px solid rgba(255,255,255,0.08);
      border-radius:14px; padding:14px; min-height:120px;
    }
    .msg-preview .preview-label{
      font-size:11px; font-weight:500; letter-spacing:0.04em;
      text-transform:uppercase; color:rgba(245,243,239,0.40); margin-bottom:10px;
    }
    .msg-bubble{
      background:rgba(245,243,239,0.93); color:var(--ink);
      border-radius:14px; border-bottom-right-radius:4px;
      padding:10px 13px; font-family:var(--font-body);
      font-size:13px; line-height:1.45; white-space:pre-wrap;
      box-shadow:0 6px 18px rgba(0,0,0,0.22);
      max-width:96%;
    }
    .msg-bubble.placeholder{ color:rgba(10,10,10,0.45); font-style:italic; }

    .hint-card{
      padding:10px 13px; border:1px dashed rgba(255,255,255,0.14);
      background:rgba(255,255,255,0.02); border-radius:12px;
      font-size:12px; color:rgba(245,243,239,0.60); line-height:1.4;
    }
    .hint-card strong{ color:rgba(245,243,239,0.85); }

    /* Screen 2 nav — bottom bar */
    .screen2-nav{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; margin-top:16px; flex-wrap:wrap;
    }

    /* ── Screen 3 ── */
    .results-grid{
      display:grid; grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px; margin:14px 0;
    }
    .result-box{
      border-radius:14px; border:1px solid var(--border);
      background:rgba(255,255,255,0.03); padding:14px;
    }
    .result-box .r-label{
      font-size:11px; font-weight:600; letter-spacing:0.04em;
      text-transform:uppercase; color:rgba(245,243,239,0.50); margin-bottom:8px;
    }
    .result-box .r-value{
      font-family:var(--font-display); font-weight:800; font-size:22px;
      letter-spacing:-0.03em; line-height:1;
    }
    .result-box .r-sub{
      font-size:12px; color:rgba(245,243,239,0.50); margin-top:5px;
    }
    .result-box.rb-green{ border-color:rgba(0,200,122,0.30); background:rgba(0,200,122,0.08); }
    .result-box.rb-yellow{ border-color:rgba(245,213,60,0.28); background:rgba(245,213,60,0.08); }
    .result-box.rb-gray{ border-color:rgba(255,255,255,0.10); }

    .tl-list{ display:grid; gap:8px; margin-top:12px; }
    .tl-item{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:10px; padding:10px 14px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.02);
    }
    .tl-item .tl-name{
      font-family:var(--font-display); font-weight:700; font-size:13px;
      letter-spacing:-0.01em;
    }
    .tl-item .tl-desc{
      font-size:12px; color:rgba(245,243,239,0.55); margin-top:3px;
    }
    .tl-steps{ font-size:12px; color:rgba(245,243,239,0.60); margin-top:4px; line-height:1.4; }
    .tl-steps .ok{ color:rgba(0,200,122,0.95); font-weight:700; }
    .tl-steps .warn{ color:rgba(245,213,60,0.95); font-weight:700; }
    .tl-steps .dim{ color:rgba(245,243,239,0.45); }

    .callout-bar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap; padding:14px 16px;
      border:1px solid rgba(0,200,122,0.30);
      background:rgba(0,200,122,0.10); border-radius:14px;
      margin-top:12px;
    }
    .callout-bar .cb-text{
      font-family:var(--font-display); font-weight:700; font-size:14px;
    }
    .callout-bar .cb-num{
      color:var(--green); font-size:15px;
    }

    /* ── WhatsApp modal ── */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,0.65);
      display:none; align-items:center; justify-content:center;
      padding:16px; z-index:50;
    }
    .modal-backdrop.open{ display:flex; }
    .modal{
      width:min(540px,100%); border-radius:20px;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(12,12,12,0.95);
      box-shadow:0 30px 70px rgba(0,0,0,0.60); overflow:hidden;
    }
    .modal-top{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:12px 16px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.025);
    }
    .modal-who .mw-name{
      font-family:var(--font-display); font-weight:700; font-size:14px;
      letter-spacing:-0.01em;
    }
    .modal-who .mw-meta{
      font-size:11px; color:rgba(245,243,239,0.55); margin-top:2px;
    }
    .chat-body{
      background:linear-gradient(180deg, rgba(0,200,122,0.09) 0%, rgba(0,200,122,0.03) 100%);
      padding:16px; min-height:360px; max-height:60vh; overflow-y:auto;
      display:flex; flex-direction:column; gap:10px;
    }
    .chat-sys{
      text-align:center; font-size:11px;
      color:rgba(245,243,239,0.45); margin-bottom:4px;
    }
    .bubble-row{ display:flex; }
    .bubble-row.sent{ justify-content:flex-end; }
    .bubble-row.recv{ justify-content:flex-start; }
    .chat-bubble{
      max-width:80%; padding:10px 13px; border-radius:16px;
      font-family:var(--font-body); font-size:13px; line-height:1.4;
      white-space:pre-wrap; box-shadow:0 4px 12px rgba(0,0,0,0.25);
    }
    .chat-bubble.sent{
      background:rgba(245,243,239,0.94); color:var(--ink);
      border-bottom-right-radius:4px;
    }
    .chat-bubble.recv{
      background:rgba(255,255,255,0.10); color:rgba(245,243,239,0.90);
      border:1px solid rgba(255,255,255,0.12); border-bottom-left-radius:4px;
    }

    /* ── Responsive ── */
    @media(max-width:900px){
      .metrics{ grid-template-columns:repeat(2,minmax(0,1fr)); }
      .split{ grid-template-columns:1fr; }
      .results-grid{ grid-template-columns:1fr; }
    }
    @media(max-width:480px){
      .metric .m-value{ font-size:18px; }
      .result-box .r-value{ font-size:18px; }
      .bar-row{ grid-template-columns:60px 1fr 86px; }
      thead th{ font-size:10px; padding:8px 10px; }
      tbody td{ font-size:12px; padding:9px 10px; }
    }
  </style>
</head>
<body>
<div class="app">

  <header>
    <div class="brand">
      <svg class="logo-svg" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="32" height="32" rx="9" fill="#0a0a0a"/>
        <path d="M6 22 L12 12 L16 18 L20 9 L26 9" stroke="#00c87a" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="26" cy="9" r="2.2" fill="#00c87a"/>
      </svg>
      <div class="brand-text">
        <div class="kicker">Ventia</div>
        <h1>COBROSMART — Demo</h1>
      </div>
    </div>
    <div class="pills">
      <div class="pill"><strong>Negocio:</strong> El Puente (Azul, BA)</div>
      <div class="pill"><strong>Dueño:</strong> Gustavo "Tavo" Ibarra</div>
    </div>
  </header>

  <!-- ══════════════════════════════════════
       SCREEN 1 — RESUMEN DE DEUDA
  ══════════════════════════════════════ -->
  <section id="s1" class="screen active">
    <div class="card">
      <h2>Resumen de deuda y foco</h2>
      <div class="subtle">Vista rápida para decidir dónde cobrar primero — datos importados.</div>
      <div class="card" style="margin-top:12px; background:rgba(255,255,255,0.02); box-shadow:none; border-color:rgba(255,255,255,0.07);">
        <div class="subtle" style="margin-bottom:8px;">
          Exportá tu Excel a CSV. Columnas: cliente_nombre, telefono, monto, dias_vencido (o fecha_vencimiento), obra (opcional).
        </div>
        <div class="btn-row">
          <input id="csvFileInput" type="file" accept=".csv" style="max-width:260px;" />
          <button class="btn btn-ghost btn-sm" id="btnImportCsv" type="button">Importar CSV</button>
        </div>
        <div class="subtle" id="csvImportResult" style="margin-top:8px;"></div>
      </div>

      <div class="metrics">
        <div class="metric">
          <div class="m-label">Vencido total</div>
          <div class="m-value">$7.980.000</div>
          <div class="m-hint">Cuenta corriente</div>
        </div>
        <div class="metric">
          <div class="m-label">Deudores vencidos</div>
          <div class="m-value">33</div>
          <div class="m-hint">+7 días</div>
        </div>
        <div class="metric">
          <div class="m-label">Vencido 31+ días</div>
          <div class="m-value">$4.310.000</div>
          <div class="m-hint">Foco de recuperación</div>
        </div>
        <div class="metric">
          <div class="m-label">Promesas activas</div>
          <div class="m-value">1</div>
          <div class="m-hint">Seguimiento auto</div>
        </div>
      </div>

      <div class="card" style="background:rgba(255,255,255,0.02); box-shadow:none; border-color:rgba(255,255,255,0.07);">
        <h2>Distribución por antigüedad</h2>
        <div class="subtle" style="margin-bottom:4px;">Las franjas de 31+ días se priorizan (verde más intenso).</div>
        <div class="bars" id="ageBars"></div>
      </div>

      <div class="btn-row" style="margin-top:16px;">
        <button class="btn btn-primary" id="btnStart">Iniciar campaña de cobro →</button>
        <button class="btn btn-ghost" id="btnJump">Saltar a resultados</button>
      </div>
    </div>

    <div class="roi-strip">
      <div class="roi-top">
        <div class="roi-big">ROI conservador 30 días (20%) → <span>$862.000</span></div>
        <div class="pill" style="border-color:rgba(255,77,28,0.22); background:rgba(255,77,28,0.07);">
          <strong>Vencido 31+:</strong> $4.310.000
        </div>
      </div>
      <div class="roi-small">Con que recuperés una deuda media de <strong style="color:rgba(245,243,239,0.85);">$180.000–$250.000</strong> en el mes, esto ya se pagó varias veces.</div>
    </div>
  </section>

  <!-- ══════════════════════════════════════
       SCREEN 2 — LISTA + MENSAJE
  ══════════════════════════════════════ -->
  <section id="s2" class="screen">
    <div class="card">
      <h2>Lista priorizada + mensaje sugerido</h2>
      <div class="subtle">Hacé click en un deudor para ver el mensaje listo para WhatsApp.</div>

      <div class="split">
        <!-- Tabla -->
        <div>
          <div class="table-wrap">
            <table aria-label="Deudores">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th class="tc">Días</th>
                  <th class="tr">Monto</th>
                  <th class="tc">Estado</th>
                </tr>
              </thead>
              <tbody id="debtorsTbody"></tbody>
            </table>
          </div>
          <div class="hint-card" style="margin-top:10px;">
            Tip: en una demo guiada, empezá por <strong>31+ días</strong> y dejá "prometió" para mostrar el seguimiento automático.
          </div>
        </div>

        <!-- Panel mensaje -->
        <div class="msg-panel card" style="margin:0; background:rgba(255,255,255,0.02); box-shadow:none; border-color:rgba(255,255,255,0.07);">
          <div class="panel-head">
            <div>
              <h3 id="panelName">Seleccioná un deudor</h3>
              <div class="p-meta" id="panelMeta">Vas a ver el mensaje sugerido y la conversación.</div>
            </div>
            <button class="btn btn-ghost btn-sm" id="btnConv" disabled>Ver conversación</button>
          </div>

          <div>
            <div class="subtle" style="margin-bottom:6px; font-size:11px; text-transform:uppercase; letter-spacing:0.05em;">Tono del mensaje</div>
            <div class="tone-seg" role="group" aria-label="Tono">
              <button id="tA" type="button">Amable</button>
              <button id="tD" type="button">Directo</button>
              <button id="tU" type="button">Último aviso</button>
            </div>
          </div>

          <div class="msg-preview">
            <div class="preview-label">Preview WhatsApp</div>
            <div class="msg-bubble placeholder" id="msgBubble">Elegí un deudor para ver el mensaje.</div>
          </div>

          <div class="btn-row">
            <button class="btn btn-ghost btn-sm" id="btnCopy" disabled>Copiar texto</button>
            <button class="btn btn-ghost btn-sm" id="btnSent" disabled>Marcar enviado</button>
          </div>

          <div class="hint-card">
            COBROSMART ajusta el tono según antigüedad y comportamiento — <strong>ignoró / prometió / sin contacto.</strong>
          </div>
        </div>
      </div>

      <!-- Nav bottom -->
      <div class="screen2-nav">
        <button class="btn btn-ghost" id="btnBack1">← Volver</button>
        <button class="btn btn-primary" id="btnTo3">Ver resultados →</button>
      </div>
    </div>
  </section>

  <!-- ══════════════════════════════════════
       SCREEN 3 — RESULTADO DEL DÍA
  ══════════════════════════════════════ -->
  <section id="s3" class="screen">
    <div class="card">
      <h2>Resultado del día</h2>
      <div class="subtle">Resumen automático después de la campaña — simulado.</div>

      <div class="results-grid">
        <div class="result-box rb-green">
          <div class="r-label">Pagaron</div>
          <div class="r-value">$186.900</div>
          <div class="r-sub">Nico Barrionuevo</div>
        </div>
        <div class="result-box rb-yellow">
          <div class="r-label">Prometieron</div>
          <div class="r-value">$78.300</div>
          <div class="r-sub">Mariela Sosa — viernes 9:30</div>
        </div>
        <div class="result-box rb-gray">
          <div class="r-label">Sin respuesta</div>
          <div class="r-value">$910.400</div>
          <div class="r-sub">Obras Rivas + Cuadrilla Los Hermanos</div>
        </div>
      </div>

      <div class="card" style="background:rgba(255,255,255,0.02); box-shadow:none; border-color:rgba(255,255,255,0.07);">
        <h2>Estado actualizado</h2>
        <div class="subtle">Quién pagó, quién prometió y a quién seguir mañana.</div>
        <div class="tl-list" id="ranking"></div>
      </div>

      <div class="card" style="background:rgba(255,255,255,0.02); box-shadow:none; border-color:rgba(255,255,255,0.07); margin-top:10px;">
        <h2>Línea de tiempo</h2>
        <div class="subtle">Cada deudor: enviado → respuesta → resultado.</div>
        <div class="tl-list" id="timeline"></div>
      </div>

      <div class="callout-bar">
        <div>
          <span class="cb-text">Acciones automáticas programadas para mañana: </span>
          <span class="cb-num">2 seguimientos</span>
        </div>
        <div class="pill" style="border-color:rgba(0,200,122,0.28); background:rgba(0,200,122,0.08);">
          Sin backend — demo
        </div>
      </div>

      <div class="roi-strip" style="margin-top:12px;">
        <div class="roi-top">
          <div class="roi-big">Momento ROI: con 1 deuda media recuperada, <span>se paga solo.</span></div>
          <div class="pill"><strong>Recuperable 30 días:</strong> $862.000</div>
        </div>
        <div class="roi-small">"Con que recuperés una deuda media de $180.000–$250.000 en el mes, esto ya se pagó varias veces."</div>
      </div>

      <div class="btn-row" style="margin-top:16px;">
        <button class="btn btn-ghost" id="btnBack2">← Volver a mensajes</button>
        <button class="btn btn-ghost" id="btnHome">← Volver al inicio</button>
      </div>
    </div>
  </section>

</div>

<!-- WhatsApp Modal -->
<div class="modal-backdrop" id="modalBg" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modal-top">
      <div class="modal-who">
        <div class="mw-name" id="chatName">—</div>
        <div class="mw-meta">Simulación WhatsApp · solo demo</div>
      </div>
      <button class="btn btn-ghost btn-sm" id="btnClose">Cerrar</button>
    </div>
    <div class="chat-body" id="chatBody"></div>
  </div>
</div>

<script>
  const fmt = n => "$" + Math.round(n || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const esc = s => String(s || "").replace(/[&<>"']/g, m => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", "\"":"&quot;", "'":"&#039;" }[m]));

  let debtors = [];
  let selId = null;
  let tone = "amable";
  const sentMap = {};

  function showScreen(n){
    $$(".screen").forEach(s => s.classList.remove("active"));
    $("#s" + n).classList.add("active");
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function badge(sc, text){
    const cls = sc === "red" ? "s-red" : sc === "green" ? "s-green" : "s-yellow";
    return `<span class="badge ${cls}"><span class="dot"></span>${esc(text)}</span>`;
  }

  function statusLabel(lastStatus){
    if (lastStatus === "ignored") return "Ignoro";
    if (lastStatus === "promised") return "Prometio";
    if (lastStatus === "paid") return "Pago";
    if (lastStatus === "contacted") return "Contactado";
    return "Nuevo";
  }

  function scoreColor(priorityScore, days){
    if ((priorityScore || 0) >= 180 || days >= 45) return "red";
    if ((priorityScore || 0) >= 90 || days >= 20) return "yellow";
    return "green";
  }

  function defaultToneByScore(sc){
    if (sc === "red") return "ultimo";
    if (sc === "yellow") return "directo";
    return "amable";
  }

  function buildMessages(d){
    return {
      amable: `Hola ${d.name}, te escribo por la cuenta pendiente del corralon: ${fmt(d.amount)} (${d.days} dias). Si queres lo dejamos ordenado hoy.`,
      directo: `Hola ${d.name}, quedo pendiente ${fmt(d.amount)} (${d.days} dias vencidos). Confirmame por favor una fecha concreta de pago.`,
      ultimo: `Hola ${d.name}, ultimo aviso por saldo pendiente ${fmt(d.amount)} (${d.days} dias). Necesito confirmacion hoy o comprobante si ya fue abonado.`
    };
  }

  function buildConversation(d){
    return {
      amable: [
        { who: "sent", text: d.messages.amable },
        { who: "recv", text: "Recibido, hoy lo reviso." }
      ],
      directo: [
        { who: "sent", text: d.messages.directo },
        { who: "recv", text: "Te confirmo en un rato." }
      ],
      ultimo: [
        { who: "sent", text: d.messages.ultimo },
        { who: "recv", text: "Entendido, te paso fecha hoy." }
      ]
    };
  }

  function normalizeDebtor(raw){
    const id = raw.id || `${raw.phone || "d"}-${Math.random().toString(36).slice(2, 8)}`;
    const days = Number(raw.days_overdue || 0);
    const amount = Number(raw.amount_ars || 0);
    const sc = scoreColor(raw.priority_score, days);
    const debtor = {
      id,
      name: raw.name || "Sin nombre",
      phone: raw.phone || "",
      days,
      amount,
      status: statusLabel(raw.last_status),
      sc,
      priorityReason: raw.priority_reason || "",
      defaultTone: defaultToneByScore(sc),
      messages: null,
      conv: null
    };
    debtor.messages = buildMessages(debtor);
    debtor.conv = buildConversation(debtor);
    return debtor;
  }

  function computeBuckets(items){
    const sums = { b1:0, b2:0, b3:0, b4:0 };
    items.forEach(d => {
      if (d.days <= 15) sums.b1 += d.amount;
      else if (d.days <= 30) sums.b2 += d.amount;
      else if (d.days <= 60) sums.b3 += d.amount;
      else sums.b4 += d.amount;
    });
    return [
      { key: "0–15d", amount: sums.b1, cls: "" },
      { key: "16–30d", amount: sums.b2, cls: "" },
      { key: "31–60d", amount: sums.b3, cls: "prio2" },
      { key: "61+d", amount: sums.b4, cls: "prio" }
    ];
  }

  function renderBars(){
    const buckets = computeBuckets(debtors);
    const max = Math.max(1, ...buckets.map(b => b.amount));
    const el = $("#ageBars");
    el.innerHTML = "";
    buckets.forEach(b => {
      const pct = Math.max(6, Math.round((b.amount / max) * 100));
      el.insertAdjacentHTML("beforeend", `
        <div class="bar-row ${b.cls}">
          <div class="b-label">${b.key}</div>
          <div class="bar-track"><div class="bar-fill" style="width:${pct}%"></div></div>
          <div class="b-amt">${fmt(b.amount)}</div>
        </div>`);
    });
  }

  function renderTable(){
    const tbody = $("#debtorsTbody");
    tbody.innerHTML = "";
    debtors.forEach(d => {
      const tr = document.createElement("tr");
      tr.dataset.id = d.id;
      tr.innerHTML = `
        <td>${esc(d.name)}</td>
        <td class="tc">${d.days}</td>
        <td class="tr">${fmt(d.amount)}</td>
        <td class="tc">${badge(d.sc, d.status)}</td>`;
      tr.addEventListener("click", () => selectDebtor(d.id));
      tbody.appendChild(tr);
    });
  }

  function renderS3(){
    const rankItems = [...debtors].slice(0, 4);
    $("#ranking").innerHTML = rankItems.map(d => `
      <div class="tl-item">
        <div><div class="tl-name">${esc(d.name)}</div><div class="tl-desc">${esc(d.priorityReason || "Sin motivo de prioridad")}</div></div>
        <div>${badge(d.sc, d.status)}</div>
      </div>`).join("");

    $("#timeline").innerHTML = rankItems.map(d => `
      <div class="tl-item">
        <div><div class="tl-name">${esc(d.name)}</div><div class="tl-steps">enviado -> respuesta pendiente -> seguimiento</div></div>
        <div class="subtle" style="font-size:11px;">hoy</div>
      </div>`).join("");
  }

  function getD(id){
    return debtors.find(d => d.id === id);
  }

  function setTone(t){
    tone = t;
    ["A", "D", "U"].forEach(k => {
      const map = { A: "amable", D: "directo", U: "ultimo" };
      $("#t" + k).classList.toggle("active", map[k] === t);
    });
    updateMsg();
  }

  function updateMsg(){
    const d = selId ? getD(selId) : null;
    const el = $("#msgBubble");
    if (!d) {
      el.textContent = "Elegi un deudor para ver el mensaje.";
      el.classList.add("placeholder");
      return;
    }
    el.textContent = d.messages[tone] || "";
    el.classList.remove("placeholder");
  }

  function selectDebtor(id){
    const d = getD(id);
    if (!d) return;
    selId = id;
    $$("#debtorsTbody tr").forEach(tr => tr.classList.toggle("selected", tr.dataset.id === id));
    tone = d.defaultTone;
    setTone(tone);
    $("#panelName").textContent = d.name;
    $("#panelMeta").textContent = `${d.days} dias vencido · ${fmt(d.amount)} · ${d.status}${d.priorityReason ? " · " + d.priorityReason : ""}`;
    $("#btnConv").disabled = false;
    $("#btnCopy").disabled = false;
    $("#btnSent").disabled = false;
    const sent = sentMap[id];
    $("#btnSent").textContent = sent ? "Enviado ✓" : "Marcar enviado";
    $("#btnSent").style.borderColor = sent ? "rgba(0,200,122,0.35)" : "";
    if (window.innerWidth < 900) {
      setTimeout(() => { $("#s2 .msg-panel").scrollIntoView({ behavior: "smooth", block: "start" }); }, 80);
    }
  }

  function openModal(){
    const d = selId ? getD(selId) : null;
    if (!d) return;
    $("#chatName").textContent = d.name;
    const body = $("#chatBody");
    body.innerHTML = `<div class="chat-sys">Hoy · Mensajes simulados</div>`;
    (d.conv[tone] || []).forEach(m => {
      const row = document.createElement("div");
      row.className = "bubble-row " + (m.who === "sent" ? "sent" : "recv");
      const bub = document.createElement("div");
      bub.className = "chat-bubble " + (m.who === "sent" ? "sent" : "recv");
      bub.textContent = m.text;
      row.appendChild(bub);
      body.appendChild(row);
    });
    $("#modalBg").classList.add("open");
    setTimeout(() => { body.scrollTop = body.scrollHeight; }, 0);
  }

  function closeModal(){
    $("#modalBg").classList.remove("open");
  }

  async function fetchDebtors(){
    const res = await fetch("/api/debtors?sort=priority");
    if (!res.ok) {
      throw new Error("No se pudo cargar /api/debtors");
    }
    const payload = await res.json();
    const items = Array.isArray(payload) ? payload : (payload.items || []);
    debtors = items.map(normalizeDebtor);
  }

  function parseCsvRows(csvText){
    const firstLine = csvText.split(/\r?\n/).find(line => line.trim()) || "";
    const delimiter = (firstLine.split(";").length > firstLine.split(",").length) ? ";" : ",";
    const rows = [];
    let current = "";
    let row = [];
    let inQuotes = false;
    for (let i = 0; i < csvText.length; i += 1) {
      const ch = csvText[i];
      const next = csvText[i + 1];
      if (ch === "\"") {
        if (inQuotes && next === "\"") {
          current += "\"";
          i += 1;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (ch === delimiter && !inQuotes) {
        row.push(current);
        current = "";
      } else if ((ch === "\n" || ch === "\r") && !inQuotes) {
        if (ch === "\r" && next === "\n") i += 1;
        row.push(current);
        if (row.some(cell => String(cell).trim() !== "")) rows.push(row);
        row = [];
        current = "";
      } else {
        current += ch;
      }
    }
    row.push(current);
    if (row.some(cell => String(cell).trim() !== "")) rows.push(row);
    return rows;
  }

  function parseFlexibleDate(input){
    if (!input) return null;
    const value = String(input).trim();
    if (!value) return null;
    if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
      const [y, m, d] = value.split("-").map(Number);
      return new Date(y, m - 1, d);
    }
    if (/^\d{2}\/\d{2}\/\d{4}$/.test(value)) {
      const [d, m, y] = value.split("/").map(Number);
      return new Date(y, m - 1, d);
    }
    const parsed = new Date(value);
    return Number.isNaN(parsed.getTime()) ? null : parsed;
  }

  function computeDaysOverdueFromDate(dateString){
    const due = parseFlexibleDate(dateString);
    if (!due) return null;
    const now = new Date();
    const startToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const startDue = new Date(due.getFullYear(), due.getMonth(), due.getDate());
    const diffMs = startToday.getTime() - startDue.getTime();
    return Math.max(0, Math.floor(diffMs / 86400000));
  }

  function parseCsvToImportRows(text){
    const matrix = parseCsvRows(text);
    if (matrix.length < 2) return [];
    const headers = matrix[0].map(h => String(h || "").trim().toLowerCase());
    return matrix.slice(1).map(row => {
      const obj = {};
      headers.forEach((header, idx) => {
        obj[header] = String(row[idx] || "").trim();
      });
      const dias = obj.dias_vencido || obj.dias || "";
      const fechaVenc = obj.fecha_vencimiento || "";
      const days = dias !== "" ? Number(dias) : computeDaysOverdueFromDate(fechaVenc);
      return {
        cliente_nombre: obj.cliente_nombre || obj.nombre || "",
        telefono: obj.telefono || obj.phone || "",
        monto: obj.monto || obj.importe || "",
        dias_vencido: Number.isFinite(days) ? days : "",
        obra: obj.obra || ""
      };
    });
  }

  function setImportResult(text, isError){
    const el = $("#csvImportResult");
    el.textContent = text;
    el.style.color = isError ? "rgba(255,110,110,0.9)" : "rgba(0,200,122,0.9)";
  }

  async function importCsv(){
    const fileInput = $("#csvFileInput");
    const file = fileInput.files && fileInput.files[0];
    if (!file) {
      alert("Elegi un archivo CSV.");
      return;
    }

    const rawText = await file.text();
    const rows = parseCsvToImportRows(rawText);
    if (!rows.length) {
      setImportResult("CSV vacio o sin filas validas.", true);
      return;
    }

    const res = await fetch("/api/import", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ rows })
    });
    const data = await res.json();
    if (!res.ok) {
      throw new Error(data.message || "Fallo la importacion.");
    }
    const summary = `Importacion OK: inserted ${data.inserted || 0}, updated ${data.updated || 0}, rejected ${data.rejected || 0}`;
    setImportResult(summary, false);
    alert(summary);
    if (Array.isArray(data.errors) && data.errors.length) {
      const topErrors = data.errors.slice(0, 5).map(e => `fila ${e.row}: ${e.message}`).join("\n");
      alert(`Errores detectados:\n${topErrors}`);
    }
    await loadAndRenderDebtors();
  }

  async function loadAndRenderDebtors(){
    await fetchDebtors();
    renderBars();
    renderTable();
    renderS3();
    if (debtors.length > 0) {
      selectDebtor(debtors[0].id);
    } else {
      selId = null;
      updateMsg();
      $("#panelName").textContent = "No hay deudores cargados";
      $("#panelMeta").textContent = "Importa un CSV para empezar.";
    }
  }

  $("#btnStart").onclick = () => showScreen(2);
  $("#btnJump").onclick = () => showScreen(3);
  $("#btnBack1").onclick = () => showScreen(1);
  $("#btnTo3").onclick = () => showScreen(3);
  $("#btnBack2").onclick = () => showScreen(2);
  $("#btnHome").onclick = () => showScreen(1);
  $("#tA").onclick = () => setTone("amable");
  $("#tD").onclick = () => setTone("directo");
  $("#tU").onclick = () => setTone("ultimo");
  $("#btnConv").onclick = openModal;
  $("#btnClose").onclick = closeModal;
  $("#modalBg").onclick = e => { if (e.target === $("#modalBg")) closeModal(); };
  document.addEventListener("keydown", e => { if (e.key === "Escape") closeModal(); });

  $("#btnCopy").onclick = async () => {
    const txt = $("#msgBubble").textContent || "";
    try {
      await navigator.clipboard.writeText(txt);
      const b = $("#btnCopy");
      const prev = b.textContent;
      b.textContent = "Copiado ✓";
      setTimeout(() => { b.textContent = prev; }, 1200);
    } catch (e) {
      alert("Copia el texto manualmente.");
    }
  };

  $("#btnSent").onclick = () => {
    if (!selId) return;
    sentMap[selId] = true;
    $("#btnSent").textContent = "Enviado ✓";
    $("#btnSent").style.borderColor = "rgba(0,200,122,0.35)";
    $("#btnSent").style.background = "rgba(0,200,122,0.08)";
  };

  $("#btnImportCsv").onclick = async () => {
    try {
      await importCsv();
    } catch (error) {
      const message = error && error.message ? error.message : "Error al importar CSV.";
      setImportResult(message, true);
      alert(message);
    }
  };

  loadAndRenderDebtors().catch((error) => {
    setImportResult("No se pudieron cargar deudores desde /api/debtors.", true);
    renderBars();
    renderTable();
    renderS3();
    console.error(error);
  });
</script>
</body>
</html>
